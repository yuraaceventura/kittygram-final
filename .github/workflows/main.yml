name: Main workflow

on:
  push:
    branches:
      - main

jobs:
  # tests:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Check out code
  #     uses: actions/checkout@v3
  #   - name: Set up Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: 3.9
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip 
  #       pip install flake8==6.0.0 flake8-isort==6.0.0
  #   - name: Test with flake8
  #     run: python -m flake8 --exit-zero backend/


  # build_and_push_to_docker_hub:
  #     name: Push Docker image to DockerHub
  #     runs-on: ubuntu-latest
  #     needs: tests
  #     steps:
  #       - name: Check out the repo
  #         uses: actions/checkout@v3
  #       - name: Set up Docker Buildx
  #         uses: docker/setup-buildx-action@v2
  #       - name: Login to Docker 
  #         uses: docker/login-action@v2
  #         # При помощи with передаём в action параметры username и password:
  #         with:
  #           username: ${{secrets.DOCKER_LOGIN}} 
  #           password: ${{secrets.DOCKER_PASSWORD}}
        
  #       - name: Build and push frontend
  #         uses: docker/build-push-action@v4
  #         with:
  #           context: ./frontend/
  #           push: true
  #           tags: 
  #             ${{ secrets.DOCKER_LOGIN }}/frontend:latest

  #       - name: Build and push backend
  #         uses: docker/build-push-action@v4
  #         with:
  #           context: ./backend/
  #           push: true
  #           tags: 
  #             ${{ secrets.DOCKER_LOGIN }}/backend:latest

  #       - name: Build and push gateway
  #         uses: docker/build-push-action@v4
  #         with:
  #           context: ./nginx/
  #           push: true
  #           tags: 
  #             ${{ secrets.DOCKER_LOGIN }}/gateway:latest


  deploy:
      runs-on: ubuntu-latest
      # needs: 
      #   - build_and_push_to_docker_hub
      steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      # Копируем docker-compose.production.yml на продакшен-сервер:
      - name: Install sshpass and copy files
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          sshpass -p '${{ secrets.SSH_PASSWORD }}' scp \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          docker-compose.production.yaml \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/deploy/app/


      - name: Executing remote ssh commands to deploy
        run: |
          sshpass -p '${{ secrets.SSH_PASSWORD }}' ssh \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile=/dev/null \
          deploy@${{ secrets.SSH_HOST }} "
          cd /home/deploy/app
          echo 'POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}' > .env
          echo 'POSTGRES_USER=${{ secrets.POSTGRES_USER }}' >> .env
          echo 'POSTGRES_DB=${{ secrets.POSTGRES_DB }}' >> .env
          sudo docker compose -f docker-compose.production.yaml pull
          sudo docker compose -f docker-compose.production.yaml down
          sudo docker compose -f docker-compose.production.yaml up -d "

          